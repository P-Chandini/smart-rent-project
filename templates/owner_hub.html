<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartRent | Owner Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --text-dark: #1e293b;
            --bg-light: #f8fafc;
        }

        body {
            margin: 0;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        nav {
            background: white;
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logo { font-weight: 800; font-size: 1.4rem; color: var(--text-dark); text-decoration: none; }
        .logo span { color: #6366f1; }

        .nav-right { display: flex; align-items: center; gap: 15px; }

        .btn-chat {
            background: white; color: var(--text-dark); padding: 8px 18px; 
            border-radius: 50px; text-decoration: none; font-weight: 700; 
            font-size: 0.85rem; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 8px;
        }

        .btn-switch { 
            background: #eef2ff; color: #6366f1; padding: 8px 18px; 
            border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 0.85rem;
        }

        .container { padding: 40px 8%; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 25px; border-radius: 20px; border: 1px solid #f1f5f9; display: flex; align-items: center; gap: 20px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 15px; background: #f5f3ff; color: #a855f7; display: flex; align-items: center; justify-content: center; }

        .btn-add { background: var(--primary-gradient); color: white; padding: 12px 25px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; box-shadow: 0 10px 15px rgba(99, 102, 241, 0.2); }

        #propModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 35px; border-radius: 24px; width: 90%; max-width: 500px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 700; font-size: 0.85rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1.5px solid #f1f5f9; border-radius: 10px; font-family: inherit; box-sizing: border-box; }
        .btn-submit-prop { width: 100%; padding: 14px; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

    <nav>
        <a href="/" class="logo">Smart<span>Rent</span></a>
        <div class="nav-right">
            <a href="/services" class="btn-chat">
                <i class="fa-solid fa-tools"></i> Services
            </a>
            <a href="/chat" class="btn-chat">
                <i class="fa-regular fa-comment-dots"></i> Chat
            </a>
            <a href="/switch_role" class="btn-switch">Switch to Tenant</a>
            <a href="/logout" style="color: #64748b; text-decoration: none; font-size: 0.9rem;">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1>Owner Dashboard</h1>
            <button class="btn-add" onclick="document.getElementById('propModal').style.display='flex'">
                <i class="fa-solid fa-plus"></i> List Property
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fa-solid fa-house"></i></div>
                <div><h3>{{ prop_count }}</h3><p>Active Listings</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #ecfdf5; color: #10b981;"><i class="fa-solid fa-message"></i></div>
                <div><h3>Active</h3><p>Chat Support</p></div>
            </div>
        </div>

        {% if prop_count == 0 %}
        <div style="text-align: center; padding: 60px; background: white; border-radius: 20px; border: 2px dashed #e2e8f0;">
            <p style="color: #64748b;">No properties listed yet. Click 'List Property' to start earning.</p>
        </div>
        {% else %}
        <div style="padding: 20px; background: white; border-radius: 20px; border: 1px solid #f1f5f9;">
            <h3 style="margin-top: 0;">Listing Management</h3>
            <p style="color: #64748b; font-size: 0.9rem;">Your properties are live and visible to all tenants. Manage your listings below.</p>
            <div style="margin-top:12px;">
                {% for p in properties %}
                <div style="display:flex; align-items:center; gap:12px; padding:10px; border-radius:12px; border:1px solid #f1f5f9; margin-bottom:8px; background:#fff">
                    <img src="/static/uploads/{{ p.image_url }}" style="width:80px;height:60px; object-fit:cover; border-radius:8px;" onerror="this.style.display='none'">
                    <div style="flex:1">
                        <div style="font-weight:800">{{ p.title }}</div>
                        <div style="color:#64748b; font-size:0.9rem">₹{{ p.price }} • {{ p.location }}</div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end">
                        <label style="font-size:0.75rem; font-weight:700;">Status</label>
                        <input type="checkbox" data-id="{{ p.id }}" class="statusToggle" {{ 'checked' if p.status=='active' else '' }}>
                        <div style="display:flex; gap:6px; margin-top:6px;">
                            <button class="btn-edit-price" data-id="{{ p.id }}">Edit Price</button>
                            <button class="btn-edit-desc" data-id="{{ p.id }}">Edit</button>
                            <button class="delete-btn" data-id="{{ p.id }}"> <i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <section style="margin-top:30px;">
            <h2 style="font-size:1.25rem; font-weight:800;">Service Requests</h2>
            <p style="color:#64748b; margin-bottom:12px">Recent service bookings from tenants.</p>
            <div style="background:white; padding:12px; border-radius:12px; border:1px solid #f1f5f9;">
                {% if bookings and bookings|length > 0 %}
                    <ul style="list-style:none; padding:0; margin:0">
                    {% for b in bookings %}
                        <li style="padding:10px 0; border-bottom:1px solid #f1f5f9">
                            <strong>{{ b.service_type }}</strong> — {{ b.description or 'No description' }}<br>
                            <small class="text-gray-500">by user #{{ b.user_id }} • {{ b.timestamp }} • {{ b.status }}</small>
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p style="color:#94a3b8;">No recent service requests.</p>
                {% endif %}
        
                <section style="margin-top:24px;">
                    <h2 style="font-size:1.25rem; font-weight:800;">Service Providers</h2>
                    <p style="color:#64748b;">Add contact details for local service providers so tenants can call or pay directly.</p>
                    <div style="margin-top:12px;">
                        <button class="btn-add" onclick="document.getElementById('providerModal').style.display='flex'">Add Provider</button>
                    </div>
                    <div style="margin-top:12px; background:white; padding:12px; border-radius:12px; border:1px solid #f1f5f9;">
                        {% set provs = get_providers() if false else [] %}
                        <!-- Providers will be visible on the public services page; owners can manage theirs here in future updates. -->
                        <p style="color:#94a3b8;">Providers are visible on the Services page.</p>
                    </div>
                </section>
            </div>
        </section>

        <section style="margin-top:30px;">
            <h2 style="font-size:1.25rem; font-weight:800;">Rental Requests</h2>
            <p style="color:#64748b; margin-bottom:12px">Tenants can request to rent a listing — accept or reject below.</p>
            <div id="rentalRequests" style="background:white; padding:12px; border-radius:12px; border:1px solid #f1f5f9;">
                <p style="color:#94a3b8;">Loading requests...</p>
            </div>
        </section>
    </div>

    <div id="propModal">
        <div class="modal-content">
            <h2 style="margin-top: 0; margin-bottom: 20px;">New Property</h2>
            <form action="/add_property" method="POST" enctype="multipart/form-data">
                <div class="form-group"><label>Property Title</label><input type="text" name="title" placeholder="e.g. Modern PG in Vizag" required></div>
                <div class="form-group"><label>Monthly Rent (₹)</label><input type="number" name="price" placeholder="8000" required></div>
                <div class="form-group"><label>Exact Location</label>
                    <div style="display:flex; gap:8px; align-items:center;"><input id="propLocation" type="text" name="location" placeholder="City, Area" required>
                    <button type="button" id="useMyLoc" style="padding:8px 10px; border-radius:8px; background:#eef2ff; border:none; cursor:pointer; font-weight:700;">Use my location</button></div></div>
                <div class="form-group"><label>Property Image</label>
                    <input type="file" name="image" id="propImageInput" accept="image/*" required>
                    <div id="propPreview" style="margin-top:10px;"></div>
                </div>
                <div class="form-group"><label>Full Description</label><textarea name="description" rows="3" placeholder="Describe amenities like Wi-Fi, Food, AC..."></textarea></div>
                <button type="submit" class="btn-submit-prop">Post Listing</button>
                <button type="button" onclick="document.getElementById('propModal').style.display='none'" style="background:none; border:none; width:100%; margin-top:15px; cursor:pointer; color:#94a3b8; font-weight: 600;">Discard Draft</button>
            </form>
        </div>
    </div>

    <div id="providerModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,0.6);">
        <div style="background:white; padding:20px; border-radius:12px; width:90%; max-width:420px;">
            <h3 style="margin-top:0">Add Service Provider</h3>
            <div style="display:grid; gap:8px;">
                <input id="provName" placeholder="Name" class="form-group" />
                <input id="provPhone" placeholder="Phone" class="form-group" />
                <select id="provService" class="form-group"><option>Plumber</option><option>Electrician</option><option>Cleaner</option></select>
                <input id="provUpi" placeholder="UPI ID (optional)" class="form-group" />
                <textarea id="provDetails" placeholder="Details / address" class="form-group"></textarea>
                <div style="display:flex; gap:8px; justify-content:flex-end;"><button onclick="document.getElementById('providerModal').style.display='none'" class="btn-submit-prop">Cancel</button><button id="saveProv" class="btn-add">Save Provider</button></div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('saveProv')?.addEventListener('click', async ()=>{
            const name = document.getElementById('provName').value;
            const phone = document.getElementById('provPhone').value;
            const service = document.getElementById('provService').value;
            const upi = document.getElementById('provUpi').value;
            const details = document.getElementById('provDetails').value;
            if(!name || !phone) return alert('Name and phone required');
            const res = await fetch('/api/add_provider', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, phone, service_type:service, upi_id:upi, details})});
            const j = await res.json(); if(j.status=='ok'){ alert('Saved'); location.reload(); } else alert('Error');
        });
    </script>

    <script>
        async function loadRentalRequests(){
            const el = document.getElementById('rentalRequests');
            const res = await fetch('/api/get_rental_requests');
            if(!res.ok) { el.innerHTML = '<p class="text-red">Unable to load</p>'; return; }
            const data = await res.json();
            if(!data || data.length===0){ el.innerHTML = '<p style="color:#94a3b8;">No rental requests at the moment.</p>'; return; }
            const ul = document.createElement('div'); ul.style.display='grid'; ul.style.gap='8px';
            data.forEach(r=>{
                const card = document.createElement('div'); card.style.padding='10px'; card.style.border='1px solid #f1f5f9'; card.style.borderRadius='8px';
                card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                    <div><strong>${r.property_title || ('Property #' + r.property_id)}</strong><div style="color:#64748b; font-size:0.9rem">Requested by: ${r.tenant_name || ('#'+r.tenant_id)} • ₹${r.amount} • ${r.timestamp}</div></div>
                    <div style="display:flex; gap:8px">
                        <button class="btn-accept" data-id="${r.id}" style="background:#10b981;color:white;padding:8px 10px;border-radius:8px;border:none;">Accept</button>
                        <button class="btn-reject" data-id="${r.id}" style="background:#ef4444;color:white;padding:8px 10px;border-radius:8px;border:none;">Reject</button>
                    </div>
                </div>`;
                ul.appendChild(card);
            });
            el.innerHTML=''; el.appendChild(ul);
        }

        document.addEventListener('click', async (e)=>{
            if(e.target.classList.contains('btn-accept') || e.target.classList.contains('btn-reject')){
                const id = e.target.getAttribute('data-id');
                const action = e.target.classList.contains('btn-accept') ? 'accept' : 'reject';
                if(action==='reject' && !confirm('Reject this request?')) return;
                const res = await fetch('/api/respond_request', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({rental_request_id: id, action})});
                const j = await res.json(); if(j.status==='ok'){ alert('Updated: '+j.new); loadRentalRequests(); } else alert('Error');
            }
        });

        // load on page ready
        window.addEventListener('load', ()=>{ loadRentalRequests(); });
    </script>

    <script>
        // handlers for inline property controls
        document.addEventListener('click', async (e)=>{
            if(e.target.classList.contains('statusToggle')){
                const id = e.target.getAttribute('data-id');
                const res = await fetch('/api/toggle_property_status', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({property_id:id})});
                const j = await res.json(); if(j.new) e.target.checked = (j.new=='active');
            }
            if(e.target.classList.contains('btn-edit-price')){
                const id = e.target.getAttribute('data-id');
                const val = prompt('New price (₹)'); if(!val) return; await fetch('/api/update_property', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({property_id:id, field:'price', value:val})}); location.reload();
            }
            if(e.target.classList.contains('btn-edit-desc')){
                const id = e.target.getAttribute('data-id');
                const val = prompt('Update description'); if(val===null) return; await fetch('/api/update_property', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({property_id:id, field:'description', value:val})}); location.reload();
            }
            if(e.target.closest('.delete-btn')){
                const btn = e.target.closest('.delete-btn');
                const id = btn.getAttribute('data-id'); if(!id) return; if(!confirm('Delete this property?')) return; await fetch('/api/delete_property', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({property_id:id})}); location.reload();
            }
        });
    </script>

    <script>
        // preview selected property image
        const imgInput = document.getElementById('propImageInput');
        const preview = document.getElementById('propPreview');
        imgInput?.addEventListener('change', (e)=>{
            const f = e.target.files[0];
            if(!f) return; preview.innerHTML = '';
            const img = document.createElement('img'); img.style.maxWidth='100%'; img.style.borderRadius='12px';
            img.src = URL.createObjectURL(f); preview.appendChild(img);
        });

        document.getElementById('useMyLoc')?.addEventListener('click', ()=>{
            if(!navigator.geolocation) return alert('Geolocation not supported');
            navigator.geolocation.getCurrentPosition((pos)=>{
                const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                document.getElementById('propLocation').value = lat + ", " + lng;
            }, ()=>alert('Unable to fetch location'));
        });
    </script>

</body>
</html>